<link rel="import" href="bower_components/polymer/polymer.html">
<link rel="import" href="bower_components/paper-card/paper-card.html">



<dom-module id="person-card">
    <template>
        <style is="custom-style">

        </style>
        <content>
            <paper-card class="custom-card">
                <div>
                    <paper-card heading="Profile Picture" image="http://placehold.it/350x150/FFC107/000000" alt="Profile Picture"></paper-card>
                </div>
                <div>
                    <iron-icon icon="account-circle" slot="prefix"></iron-icon>
                    <paper-card id="" class="cyan">
                        [[firstname]] [[lastname]]
                    </paper-card>

                    <paper-button id="btn" on-click="onClick">[[actionLabel]]</paper-button>

                </div>
                <div>
                    <iron-icon icon="label" slot="prefix"></iron-icon>
                    <paper-card id= "status" class="cyan">
                        [[relationship]]
                    </paper-card>
                </div>
                <div>
                    <iron-icon icon="social:domain" slot="prefix"></iron-icon>
                    <paper-card class="cyan">
                        [[university]]
                    </paper-card>
                </div>
                <div>
                    <iron-icon icon="social:school" slot="prefix"></iron-icon>
                    <paper-card class="cyan">
                        [[major]]
                    </paper-card>
                </div>
                <div>
                    <iron-icon icon="book" slot="prefix"></iron-icon>
                    <paper-card class="cyan">
                        [[gpa]]
                    </paper-card>
                </div>
            </paper-card>
        </content>
    </template>
    <script>
        Polymer({
            is: 'person-card',
            properties:{
                firstname: String,
                lastname: String,
                university: String,
                major: String,
                gpa: String,
                personemail: String,
                actionLabel: {type: String, value: "BUTTON"},
                relationship:  {type: String, observer: "relationshipChanged"}, //Tutor,Student,Unknown,pending
                relstatus:{type: String, observer: "relStatusChanged"},   //pending,accepted,
                token: String,
                email: String,
                localUrl: {type: String, value: "http://localhost:8080"},
                backendUrl: {type: String, value: "https://backend-dot-collabarter-188623.appspot.com"},
            },
            initialize: function(){
            },
            ready: function(){

            },
            onClick: function(e){
               var r = this.relationship;
               var s = this.relstatus;
               var u1 = this.localUrl + "/Connection";
               if(u1.includes("local")){
                    u1 = u1 + "?email=" + this.email;
               }
               var req1 = new XMLHttpRequest();
               var con = {"student": "","tutor": "","message": "msg","status": ""}

               if(r == "NOT CONNECTED"){
                   //post new connection request
                    req1.open('POST',u1,true);
                    con.student = this.email;
                    con.tutor = this.personemail;
                    con.status = "PENDING";
               }else if(r == "STUDENT"){
                   //delete connection
                    req1.open('DELETE',u1,true);
                    con.student = this.personemail;
                    con.tutor = this.email;

               }else if(r == "TUTOR"){
                    //delete connection
                    req1.open('DELETE',u1,true);
                    con.student = this.email;
                    con.tutor = this.personemail;
               }
               //var sj = {"search": this.searchInput}
               req1.parent_element = this;
               req1.onreadystatechange = function(){
                    console.log("request status changed");
                   if(req1.readyState == XMLHttpRequest.DONE && req1.responseText != ""){
                        //var sr = JSON.parse(this.responseText);
                        //console.log("request done");
                        //this.parent_element.searchResults = sr;
                   }
           }
           req1.send(JSON.stringify(con));

            },
            setActionLabel: function(){
                 if(this.relationship == null || this.relstatus == null){
                    return;
                 }
                 var r = this.relationship;
                 var s = this.relstatus;
                 if(r == "NOT CONNECTED"){
                    this.actionLabel = "Connect";
                 }else if(r == "STUDENT"){
                    if(s == "PENDING"){
                       this.actionLabel = "Cancel Request";
                    }else{
                        this.actionLabel = "Remove Student";
                    }
                 }else if(r == "TUTOR"){
                    if(s == "PENDING"){
                       this.actionLabel = "Cancel Request";
                    }else{
                        this.actionLabel = "Remove Tutor";
                    }
                 }

            },
            relationshipChanged(newValue, oldValue) {
                this.setActionLabel();
            },
            relStatusChanged(newValue, oldValue) {
                this.setActionLabel();
            },

        });
    </script>
</dom-module>

